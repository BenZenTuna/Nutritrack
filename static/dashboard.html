<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NutriTrack â€” Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,300;0,9..40,500;0,9..40,700;1,9..40,400&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #0d0f11;
            --surface: #161a1f;
            --surface2: #1c2127;
            --border: #2a3038;
            --text: #e8ecf0;
            --text-dim: #8892a0;
            --accent: #3ecf8e;
            --accent-dim: rgba(62, 207, 142, 0.15);
            --protein: #60a5fa;
            --carbs: #fbbf24;
            --fat: #f87171;
            --calories: #3ecf8e;
            --danger: #ef4444;
            --warning: #f59e0b;
            --radius: 12px;
            --shadow: 0 2px 12px rgba(0,0,0,0.3);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'DM Sans', sans-serif; background: var(--bg); color: var(--text); line-height: 1.6; min-height: 100vh; }

        /* â”€â”€â”€ Layout â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .app-header { position: sticky; top: 0; z-index: 100; background: rgba(13, 15, 17, 0.85); backdrop-filter: blur(20px); border-bottom: 1px solid var(--border); padding: 0 clamp(0.5rem, 2vw, 2rem); }
        .header-inner { max-width: 1400px; margin: 0 auto; display: flex; align-items: center; justify-content: space-between; height: 64px; }
        
        .date-nav { display: flex; align-items: center; gap: 0.75rem; }
        .date-nav button { background: var(--surface); border: 1px solid var(--border); color: var(--text); width: 36px; height: 36px; border-radius: 8px; cursor: pointer; font-size: 1rem; display: grid; place-items: center; transition: all 0.15s; }
        .date-nav button:hover { background: var(--surface2); border-color: var(--accent); }
        .date-nav input[type="date"] { background: var(--surface); border: 1px solid var(--border); color: var(--text); padding: 0.45rem 0.75rem; border-radius: 8px; font-family: 'Space Mono', monospace; font-size: 0.85rem; }
        .date-nav input[type="date"]::-webkit-calendar-picker-indicator { filter: invert(0.7); }

        .main-content { max-width: 1400px; margin: 0 auto; padding: 1.5rem clamp(0.25rem, 2vw, 2rem) 3rem; }

        /* â”€â”€â”€ Tabs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .tabs { display: flex; gap: 0.25rem; margin-bottom: 1.5rem; background: var(--surface); border-radius: 10px; padding: 4px; width: fit-content; }
        .tab { padding: 0.5rem 1.25rem; border-radius: 8px; border: none; background: transparent; color: var(--text-dim); font-family: 'DM Sans', sans-serif; font-size: 0.9rem; font-weight: 500; cursor: pointer; transition: all 0.2s; }
        .tab:hover { color: var(--text); }
        .tab.active { background: var(--accent); color: var(--bg); font-weight: 700; }
        .tab-panel { display: none; }
        .tab-panel.active { display: block; }

        /* â”€â”€â”€ Cards â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .grid-3 { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 1rem; margin-bottom: 1.5rem; }
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1.5rem; }
        .card { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius); padding: 1.25rem; }
        .card-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 1rem; }
        .card-title { font-size: 0.8rem; font-weight: 500; color: var(--text-dim); text-transform: uppercase; letter-spacing: 0.08em; }
        .card-value { font-family: 'Space Mono', monospace; font-size: 2rem; font-weight: 700; line-height: 1.1; }
        .card-unit { font-size: 0.8rem; color: var(--text-dim); font-weight: 400; }
        .card-subtitle { font-size: 0.85rem; color: var(--text-dim); margin-top: 0.25rem; }

        /* â”€â”€â”€ Progress Ring â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .calorie-ring-container { display: flex; align-items: center; gap: 1rem; }
        .ring-svg { width: 64px; height: 64px; transform: rotate(-90deg); flex-shrink: 0; }
        .ring-bg { fill: none; stroke: var(--surface2); stroke-width: 8; }
        .ring-progress { fill: none; stroke-width: 8; stroke-linecap: round; transition: stroke-dashoffset 0.8s ease; }
        .ring-center { display: flex; align-items: baseline; gap: 0.5rem; flex-wrap: wrap; }
        .ring-center .big-number { font-family: 'Space Mono', monospace; font-size: 1.4rem; font-weight: 700; }
        .ring-center .label { font-size: 0.78rem; color: var(--text-dim); }

        /* â”€â”€â”€ Macro Bars â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .macro-bar-group { margin-bottom: 0.9rem; }
        .macro-bar-group:last-child { margin-bottom: 0; }
        .macro-bar-label { display: flex; justify-content: space-between; font-size: 0.82rem; margin-bottom: 0.3rem; }
        .macro-bar-label .name { font-weight: 500; }
        .macro-bar-label .values { color: var(--text-dim); font-family: 'Space Mono', monospace; font-size: 0.78rem; }
        .macro-bar-track { height: 8px; background: var(--surface2); border-radius: 4px; overflow: hidden; }
        .macro-bar-fill { height: 100%; border-radius: 4px; transition: width 0.6s ease; }

        /* â”€â”€â”€ Food Log Table â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .food-log { width: 100%; }
        .food-log table { width: 100%; border-collapse: collapse; }
        .food-log th { text-align: left; font-size: 0.75rem; font-weight: 500; color: var(--text-dim); text-transform: uppercase; letter-spacing: 0.06em; padding: 0.5rem 0.75rem; border-bottom: 1px solid var(--border); }
        .food-log td { padding: 0.65rem 0.75rem; font-size: 0.88rem; border-bottom: 1px solid rgba(42, 48, 56, 0.5); }
        .food-log tr:last-child td { border-bottom: none; }
        .food-log .meal-badge { display: inline-block; padding: 0.15rem 0.55rem; border-radius: 6px; font-size: 0.72rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.04em; }
        .meal-breakfast { background: rgba(251, 191, 36, 0.15); color: #fbbf24; }
        .meal-lunch { background: rgba(96, 165, 250, 0.15); color: #60a5fa; }
        .meal-dinner { background: rgba(167, 139, 250, 0.15); color: #a78bfa; }
        .meal-snack { background: rgba(248, 113, 113, 0.15); color: #f87171; }
        .food-log .mono { font-family: 'Space Mono', monospace; font-size: 0.82rem; }
        .food-log .delete-btn, .food-log .add-btn { background: none; border: none; color: var(--text-dim); cursor: pointer; font-size: 1rem; opacity: 0.5; transition: all 0.15s; }
        .food-log .delete-btn:hover { opacity: 1; color: var(--danger); }
        .food-log .add-btn:hover { opacity: 1; color: var(--accent); }

        /* â”€â”€â”€ Charts â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .chart-container { position: relative; height: 300px; width: 100%; }
        .chart-range-btns { display: flex; gap: 0.25rem; }
        .chart-range-btns button { padding: 0.25rem 0.65rem; border-radius: 6px; border: 1px solid var(--border); background: transparent; color: var(--text-dim); font-size: 0.75rem; font-weight: 500; cursor: pointer; transition: all 0.15s; }
        .chart-range-btns button.active, .chart-range-btns button:hover { background: var(--accent-dim); border-color: var(--accent); color: var(--accent); }

        /* â”€â”€â”€ Health Cards â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .health-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1.5rem; }
        .health-card { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius); padding: 1.25rem; text-align: center; }
        .health-icon { font-size: 1.8rem; margin-bottom: 0.5rem; }
        .health-value { font-family: 'Space Mono', monospace; font-size: 1.5rem; font-weight: 700; }
        .health-label { font-size: 0.78rem; color: var(--text-dim); margin-top: 0.25rem; }
        .health-status { display: inline-block; padding: 0.15rem 0.5rem; border-radius: 6px; font-size: 0.7rem; font-weight: 600; margin-top: 0.5rem; }
        .status-normal { background: rgba(62, 207, 142, 0.15); color: var(--accent); }
        .status-warning { background: rgba(245, 158, 11, 0.15); color: var(--warning); }
        .status-danger { background: rgba(239, 68, 68, 0.15); color: var(--danger); }

        /* â”€â”€â”€ Profile Section â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .profile-form { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 1rem; }
        .form-group { margin-bottom: 0; }
        .form-group label { display: block; font-size: 0.8rem; font-weight: 500; color: var(--text-dim); margin-bottom: 0.35rem; text-transform: uppercase; letter-spacing: 0.05em; }
        .form-group input, .form-group select { width: 100%; padding: 0.6rem 0.85rem; background: var(--surface2); border: 1px solid var(--border); border-radius: 8px; color: var(--text); font-family: 'DM Sans', sans-serif; font-size: 0.95rem; transition: border-color 0.15s; }
        .form-group input:focus, .form-group select:focus { outline: none; border-color: var(--accent); }
        .btn-save { padding: 0.65rem 2rem; background: var(--accent); color: var(--bg); border: none; border-radius: 8px; font-family: 'DM Sans', sans-serif; font-size: 0.95rem; font-weight: 700; cursor: pointer; transition: all 0.15s; margin-top: 0.5rem; }
        .btn-save:hover { opacity: 0.85; transform: translateY(-1px); }

        /* â”€â”€â”€ Calc Targets Grid â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .calc-targets-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 0.75rem; }

        /* â”€â”€â”€ Empty State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .empty-state { text-align: center; padding: 3rem 1rem; color: var(--text-dim); }
        .empty-state .icon { font-size: 3rem; margin-bottom: 1rem; opacity: 0.4; }
        .empty-state p { font-size: 0.95rem; max-width: 400px; margin: 0 auto; }

    /* â”€â”€â”€ Gamification â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .gamification-panel {
        display: flex;
        gap: 1rem;
        margin-bottom: 2rem;
        background: var(--surface);
        padding: 1.5rem;
        border-radius: var(--radius);
        align-items: center;
        border: 1px solid var(--border);
        width: 100%; /* Ensure it fits container */
        box-sizing: border-box;
    }
    .gam-col { flex: 1; text-align: center; } /* Center text by default */
    .gam-header {
        margin-bottom: 0.5rem;
        font-family: 'Space Mono', monospace;
        color: var(--text-dim);
        font-size: 0.85rem;
        text-transform: uppercase;
        letter-spacing: 1px;
    }
    .gam-stat {
        display: flex;
        align-items: baseline;
        gap: 0.5rem;
        justify-content: center; /* Center content */
    }
    .gam-divider { width: 1px; height: 60px; background: var(--border); margin: 0 1rem; }

    /* â”€â”€â”€ Modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .modal-overlay {
        display: none;
        position: fixed;
        top: 0; left: 0; right: 0; bottom: 0;
        background: rgba(0, 0, 0, 0.6);
        backdrop-filter: blur(4px);
        z-index: 200;
        justify-content: center;
        align-items: center;
    }
    .modal-overlay.open { display: flex; }
    .modal {
        background: var(--surface);
        border: 1px solid var(--border);
        border-radius: var(--radius);
        padding: 1.75rem;
        width: 90%;
        max-width: 520px;
        max-height: 85vh;
        overflow-y: auto;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
    }
    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.25rem;
    }
    .modal-title { font-size: 1.1rem; font-weight: 700; }
    .modal-close {
        background: none; border: none; color: var(--text-dim);
        font-size: 1.5rem; cursor: pointer; padding: 0; line-height: 1;
    }
    .modal-close:hover { color: var(--text); }
    .modal .form-group { margin-bottom: 0.85rem; }
    .modal .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem; }
    .modal .btn-save { width: 100%; margin-top: 0.5rem; }
    .modal-msg { margin-top: 0.5rem; font-size: 0.85rem; color: var(--accent); display: none; }
    .add-entry-btn {
        background: var(--accent-dim);
        border: 1px solid transparent;
        color: var(--accent);
        width: 28px; height: 28px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 1.1rem;
        display: grid; place-items: center;
        transition: all 0.15s;
    }
    .add-entry-btn:hover {
        border-color: var(--accent);
        background: var(--accent);
        color: var(--bg);
    }

    /* â”€â”€â”€ Responsive â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    @media (max-width: 768px) {
        /* Force everything full-width */
        body { overflow-x: hidden; }
        .main-content { padding: 0; margin: 0; max-width: 100vw; width: 100%; overflow-x: hidden; }

        /* All grids â†’ single column */
        .grid-2, .grid-3, .health-grid, .profile-form, .calc-targets-grid { grid-template-columns: 1fr; gap: 0; margin-bottom: 0; }

        /* Cards go edge-to-edge like native mobile apps */
        .card, .gamification-panel, .health-card {
            border-radius: 0;
            border-left: none;
            border-right: none;
            margin-left: 0;
            margin-right: 0;
            width: 100%;
        }

        /* Header */
        .app-header { padding: 0 0.75rem; }
        .header-inner { padding: 0; }

        /* Gamification panel */
        .gamification-panel {
            flex-direction: column;
            align-items: stretch;
            gap: 1.5rem;
            padding: 1rem;
            margin-bottom: 0;
            height: auto;
        }
        .gam-divider { width: 100%; height: 1px; margin: 0.5rem 0; }
        .gam-col { text-align: left; }
        .gam-stat { justify-content: flex-start; }

        /* Tabs */
        .tabs { overflow-x: auto; width: 100%; white-space: nowrap; padding: 4px 0.75rem 5px; margin: 0.5rem 0; background: transparent; }

        /* Table */
        .food-log { overflow-x: auto; display: block; }
        .food-log table { min-width: 100%; }

        /* Charts */
        .chart-container { height: 250px; }

        /* Cards inner padding */
        .card { padding: 1rem; height: auto !important; }
        .calorie-ring-container { flex-direction: row; align-items: center; }
        .ring-svg { width: 52px; height: 52px; }
        .ring-center .big-number { font-size: 1.2rem; }

        /* Tab panels â€” slight inner padding so text doesn't touch edges */
        .tab-panel { padding: 0; }
    }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="app-header">
        <div class="header-inner">
            <div class="date-nav">
                <button onclick="changeDate(-1)" title="Previous day">â€¹</button>
                <input type="date" id="dateSelector" onchange="onDateChange()">
                <button onclick="changeDate(1)" title="Next day">â€º</button>
                <button onclick="goToday()" title="Today" style="width:auto;padding:0 0.75rem;font-size:0.8rem;">Today</button>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="main-content">
        <!-- Gamification Bar -->
        <div class="gamification-bar" style="display: flex; align-items: center; padding: 10px 20px; background: var(--surface); border-radius: var(--radius); margin-bottom: 12px; gap: 20px;">
            <span style="display: flex; align-items: center; gap: 6px; font-size: 1.1rem;">
                <span id="streak-icon" style="font-size: 2rem;">ğŸ”¥</span>
                <strong id="streak-days" style="font-size: 1.2rem;">0</strong>
                <span style="color: var(--text-dim); font-size: 0.95rem;">day streak</span>
            </span>
            <span style="color: var(--border); font-size: 1.2rem;">|</span>
            <span style="display: flex; align-items: center; gap: 6px; font-size: 1.1rem;">
                <span style="font-size: 2rem;">âš¡</span>
                <strong id="daily-points" style="font-size: 1.2rem;">0</strong>
                <span style="color: var(--text-dim); font-size: 0.95rem;">XP</span>
            </span>
        </div>

        <!-- Calories Today (below gamification, above tabs) -->
        <div class="card" style="margin-bottom: 12px; padding: 0.75rem 1rem;">
            <div class="calorie-ring-container">
                <svg class="ring-svg" viewBox="0 0 120 120">
                    <circle class="ring-bg" cx="60" cy="60" r="50"/>
                    <circle class="ring-progress" id="calorieRing" cx="60" cy="60" r="50" stroke="var(--accent)" stroke-dasharray="314.16" stroke-dashoffset="314.16"/>
                </svg>
                <div class="ring-center">
                    <span class="big-number" id="caloriesEaten">0</span>
                    <span class="label">/ <span id="calorieGoal">0</span> kcal</span>
                    <span class="label" style="color:var(--accent);">(<span id="caloriesRemaining">0</span> left)</span>
                </div>
            </div>
        </div>

        <!-- Tabs -->
        <div class="tabs">
            <button class="tab active" data-tab="overview">Overview</button>
            <button class="tab" data-tab="charts">Charts</button>
            <button class="tab" data-tab="health">Health</button>
            <button class="tab" data-tab="profile">Profile</button>
        </div>

        <!-- â•â•â• OVERVIEW TAB â•â•â• -->
        <div class="tab-panel active" id="tab-overview">
            <!-- 1. Macros -->
            <div class="card" style="margin-bottom:1rem;">
                <div class="card-header">
                    <span class="card-title">Macros</span>
                </div>
                <div id="macroBars">
                    <div class="macro-bar-group">
                        <div class="macro-bar-label">
                            <span class="name" style="color:var(--protein);">Protein</span>
                            <span class="values"><span id="status-protein" style="font-size:0.7rem;font-weight:600;margin-right:4px;"></span><span id="proteinVal">0</span>/<span id="proteinGoal">0</span>g</span>
                        </div>
                        <div class="macro-bar-track">
                            <div class="macro-bar-fill" id="proteinBar" style="width:0%;background:var(--protein);"></div>
                        </div>
                    </div>
                    <div class="macro-bar-group">
                        <div class="macro-bar-label">
                            <span class="name" style="color:var(--carbs);">Carbs</span>
                            <span class="values"><span id="status-carbs" style="font-size:0.7rem;font-weight:600;margin-right:4px;"></span><span id="carbsVal">0</span>/<span id="carbsGoal">0</span>g</span>
                        </div>
                        <div class="macro-bar-track">
                            <div class="macro-bar-fill" id="carbsBar" style="width:0%;background:var(--carbs);"></div>
                        </div>
                    </div>
                    <div class="macro-bar-group">
                        <div class="macro-bar-label">
                            <span class="name" style="color:var(--fat);">Fat</span>
                            <span class="values"><span id="status-fat" style="font-size:0.7rem;font-weight:600;margin-right:4px;"></span><span id="fatVal">0</span>/<span id="fatGoal">0</span>g</span>
                        </div>
                        <div class="macro-bar-track">
                            <div class="macro-bar-fill" id="fatBar" style="width:0%;background:var(--fat);"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 2. Food Log -->
            <div class="card food-log" style="margin-bottom:1rem;">
                <div class="card-header">
                    <span class="card-title">Food Log</span>
                    <div style="display:flex;align-items:center;gap:0.75rem;">
                        <span class="card-title" id="foodCount">0 entries</span>
                        <button class="add-entry-btn" onclick="openModal('food')" title="Add food">+</button>
                    </div>
                </div>
                <div id="foodTableContainer">
                    <table>
                        <thead>
                            <tr>
                                <th>Time</th>
                                <th>Meal</th>
                                <th>Food</th>
                                <th>Qty</th>
                                <th>Kcal</th>
                                <th>P</th>
                                <th>C</th>
                                <th>F</th>
                                <th style="text-align:right">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="foodTableBody"></tbody>
                    </table>
                </div>
                <div class="empty-state" id="foodEmpty" style="display:none;">
                    <div class="icon">ğŸ½ï¸</div>
                    <p>No food logged for this day. Tell your AI agent what you ate!</p>
                </div>
            </div>

            <!-- 4. Status (weights & deficit) -->
            <div class="card" style="margin-bottom:1rem;">
                <div class="card-header">
                    <span class="card-title">Status</span>
                    <button class="add-entry-btn" onclick="openModal('weight')" title="Log weight">+</button>
                </div>
                <div style="display:grid;gap:0.75rem;">
                    <div>
                        <div style="font-size:0.78rem;color:var(--text-dim);">Current Weight</div>
                        <div class="card-value" style="font-size:1.4rem;">
                            <span id="currentWeight">â€”</span> <span class="card-unit">kg</span>
                        </div>
                    </div>
                    <div>
                        <div style="font-size:0.78rem;color:var(--text-dim);">Goal Weight</div>
                        <div style="font-family:'Space Mono',monospace;font-size:1.1rem;font-weight:700;">
                            <span id="goalWeight">â€”</span> <span class="card-unit">kg</span>
                        </div>
                    </div>
                    <div>
                        <div style="font-size:0.78rem;color:var(--text-dim);">Activity Burned Today</div>
                        <div style="font-family:'Space Mono',monospace;font-size:1.1rem;font-weight:700;color:var(--warning);">
                            <span id="activityBurned">0</span> <span class="card-unit">kcal</span>
                        </div>
                    </div>
                    <div>
                        <div style="font-size:0.78rem;color:var(--text-dim);">Deficit Target</div>
                        <div style="font-family:'Space Mono',monospace;font-size:1.1rem;font-weight:700;color:var(--danger);">
                            <span id="deficitTarget">500</span> <span class="card-unit">kcal</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 5. Activities Today -->
            <div class="card">
                <div class="card-header">
                    <span class="card-title">Activities Today</span>
                    <button class="add-entry-btn" onclick="openModal('activity')" title="Add activity">+</button>
                </div>
                <div id="activityList"></div>
                <div class="empty-state" id="activityEmpty" style="display:none;">
                    <div class="icon">ğŸƒ</div>
                    <p>No activities logged today.</p>
                </div>
            </div>
        </div>

        <!-- â•â•â• CHARTS TAB â•â•â• -->
        <div class="tab-panel" id="tab-charts">
            <div class="grid-2">
                <!-- Calorie History Chart -->
                <div class="card">
                    <div class="card-header">
                        <span class="card-title">Calorie History</span>
                        <div class="chart-range-btns">
                            <button class="active" onclick="loadCharts(7, this)">7D</button>
                            <button onclick="loadCharts(14, this)">14D</button>
                            <button onclick="loadCharts(30, this)">30D</button>
                            <button onclick="loadCharts(90, this)">90D</button>
                        </div>
                    </div>
                    <div class="chart-container"><canvas id="calorieChart"></canvas></div>
                </div>
                
                <!-- Macro History Chart -->
                <div class="card">
                    <div class="card-header">
                        <span class="card-title">Macro Tracking</span>
                    </div>
                    <div class="chart-container"><canvas id="macroChart"></canvas></div>
                </div>
            </div>
            
            <div class="grid-2">
                <!-- Weight Chart -->
                <div class="card">
                    <div class="card-header">
                        <span class="card-title">Weight Trend</span>
                    </div>
                    <div class="chart-container"><canvas id="weightChart"></canvas></div>
                </div>
                
                <!-- Activity Chart -->
                <div class="card">
                    <div class="card-header">
                        <span class="card-title">Sport Activity</span>
                    </div>
                    <div class="chart-container"><canvas id="activityChart"></canvas></div>
                </div>
            </div>
        </div>

        <!-- â•â•â• HEALTH TAB â•â•â• -->
        <div class="tab-panel" id="tab-health">
            <!-- Latest Health Values -->
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem;">
                <span class="card-title" style="font-size:0.95rem;">Latest Measurements</span>
                <button class="add-entry-btn" onclick="openModal('health')" title="Log health measurement">+</button>
            </div>
            <div class="health-grid" id="healthCards">
                <div class="health-card">
                    <div class="health-icon">ğŸ«€</div>
                    <div class="health-value" id="bpValue">â€”/â€”</div>
                    <div class="health-label">Blood Pressure (mmHg)</div>
                    <span class="health-status" id="bpStatus"></span>
                </div>
                <div class="health-card">
                    <div class="health-icon">ğŸ©¸</div>
                    <div class="health-value" id="sugarValue">â€”</div>
                    <div class="health-label">Blood Sugar (mg/dL)</div>
                    <span class="health-status" id="sugarStatus"></span>
                </div>
                <div class="health-card">
                    <div class="health-icon">ğŸ’¨</div>
                    <div class="health-value" id="oxygenValue">â€”</div>
                    <div class="health-label">Blood Oxygen (SpOâ‚‚ %)</div>
                    <span class="health-status" id="oxygenStatus"></span>
                </div>
                <div class="health-card">
                    <div class="health-icon">ğŸ’“</div>
                    <div class="health-value" id="hrValue">â€”</div>
                    <div class="health-label">Heart Rate (BPM)</div>
                    <span class="health-status" id="hrStatus"></span>
                </div>
            </div>

            <!-- Health Charts -->
            <div class="grid-2">
                <div class="card">
                    <div class="card-header"><span class="card-title">Blood Pressure History</span></div>
                    <div class="chart-container"><canvas id="bpChart"></canvas></div>
                </div>
                <div class="card">
                    <div class="card-header"><span class="card-title">Blood Sugar & Oxygen History</span></div>
                    <div class="chart-container"><canvas id="sugarOxyChart"></canvas></div>
                </div>
            </div>
        </div>

        <!-- â•â•â• PROFILE TAB â•â•â• -->
        <div class="tab-panel" id="tab-profile">
            <div class="card">
                <div class="card-header"><span class="card-title">Your Profile</span></div>
                <p style="color:var(--text-dim);font-size:0.9rem;margin-bottom:1.25rem;">
                    Your calorie goals and macro targets are calculated from this data. Update it whenever your stats change.
                </p>
                <div class="profile-form" id="profileForm">
                    <div class="form-group">
                        <label>Age</label>
                        <input type="number" id="pAge" min="10" max="120" placeholder="30">
                    </div>
                    <div class="form-group">
                        <label>Sex</label>
                        <select id="pSex">
                            <option value="male">Male</option>
                            <option value="female">Female</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Height (cm)</label>
                        <input type="number" id="pHeight" min="50" max="300" step="0.1" placeholder="175">
                    </div>
                    <div class="form-group">
                        <label>Current Weight (kg)</label>
                        <input type="number" id="pWeight" min="20" max="500" step="0.1" placeholder="85">
                    </div>
                    <div class="form-group">
                        <label>Activity Level</label>
                        <select id="pActivity">
                            <option value="sedentary">Sedentary (desk job)</option>
                            <option value="light">Light (1-3 days/week)</option>
                            <option value="moderate" selected>Moderate (3-5 days/week)</option>
                            <option value="active">Active (6-7 days/week)</option>
                            <option value="very_active">Very Active (2x/day)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Goal Weight (kg)</label>
                        <input type="number" id="pGoalWeight" min="20" max="500" step="0.1" placeholder="78">
                    </div>
                    <div class="form-group">
                        <label>Calorie Deficit (kcal)</label>
                        <input type="number" id="pDeficit" min="0" max="2000" value="500">
                    </div>
                </div>
                <div style="display:flex;gap:0.75rem;margin-top:1.25rem;">
                    <button class="btn-save" onclick="saveProfile()">Save Profile</button>
                </div>
                <div id="profileMsg" style="margin-top:0.75rem;font-size:0.9rem;color:var(--accent);display:none;"></div>

                <!-- Calculated Goals Display -->
                <div style="margin-top:1.5rem;padding-top:1.25rem;border-top:1px solid var(--border);">
                    <div class="card-title" style="margin-bottom:0.75rem;">Calculated Daily Targets</div>
                    <div class="calc-targets-grid" id="calcTargets">
                        <div><span style="color:var(--text-dim);font-size:0.78rem;">BMR</span><br><span class="mono" id="calcBMR">â€”</span> kcal</div>
                        <div><span style="color:var(--text-dim);font-size:0.78rem;">TDEE</span><br><span class="mono" id="calcTDEE">â€”</span> kcal</div>
                        <div><span style="color:var(--text-dim);font-size:0.78rem;">Calorie Goal</span><br><span class="mono" id="calcCalGoal" style="color:var(--accent);">â€”</span> kcal</div>
                        <div><span style="color:var(--text-dim);font-size:0.78rem;">Protein</span><br><span class="mono" id="calcProt" style="color:var(--protein);">â€”</span> g</div>
                        <div><span style="color:var(--text-dim);font-size:0.78rem;">Carbs</span><br><span class="mono" id="calcCarbs" style="color:var(--carbs);">â€”</span> g</div>
                        <div><span style="color:var(--text-dim);font-size:0.78rem;">Fat</span><br><span class="mono" id="calcFat" style="color:var(--fat);">â€”</span> g</div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- â•â•â• MODALS â•â•â• -->
    <div class="modal-overlay" id="modal-food">
        <div class="modal">
            <div class="modal-header">
                <span class="modal-title">Add Food Entry</span>
                <button class="modal-close" onclick="closeModal('food')">&times;</button>
            </div>
            <div class="form-group">
                <label>Food Name</label>
                <input type="text" id="mfName" placeholder="e.g. Grilled chicken breast">
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>Calories (kcal)</label>
                    <input type="number" id="mfCalories" min="0" step="1" placeholder="350">
                </div>
                <div class="form-group">
                    <label>Meal Type</label>
                    <select id="mfMealType">
                        <option value="breakfast">Breakfast</option>
                        <option value="lunch">Lunch</option>
                        <option value="dinner">Dinner</option>
                        <option value="snack" selected>Snack</option>
                    </select>
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>Protein (g)</label>
                    <input type="number" id="mfProtein" min="0" step="0.1" placeholder="30">
                </div>
                <div class="form-group">
                    <label>Carbs (g)</label>
                    <input type="number" id="mfCarbs" min="0" step="0.1" placeholder="45">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>Fat (g)</label>
                    <input type="number" id="mfFat" min="0" step="0.1" placeholder="12">
                </div>
                <div class="form-group">
                    <label>Quantity</label>
                    <input type="text" id="mfQuantity" placeholder="e.g. 200g, 1 plate">
                </div>
            </div>
            <div class="form-group">
                <label>Notes (optional)</label>
                <input type="text" id="mfNotes" placeholder="">
            </div>
            <button class="btn-save" onclick="submitFood()">Add Food</button>
            <div class="modal-msg" id="mfMsg"></div>
        </div>
    </div>

    <div class="modal-overlay" id="modal-weight">
        <div class="modal">
            <div class="modal-header">
                <span class="modal-title">Log Weight</span>
                <button class="modal-close" onclick="closeModal('weight')">&times;</button>
            </div>
            <div class="form-group">
                <label>Weight (kg)</label>
                <input type="number" id="mwWeight" min="20" max="500" step="0.1" placeholder="83.5">
            </div>
            <div class="form-group">
                <label>Notes (optional)</label>
                <input type="text" id="mwNotes" placeholder="e.g. Morning, fasted">
            </div>
            <button class="btn-save" onclick="submitWeight()">Log Weight</button>
            <div class="modal-msg" id="mwMsg"></div>
        </div>
    </div>

    <div class="modal-overlay" id="modal-activity">
        <div class="modal">
            <div class="modal-header">
                <span class="modal-title">Log Activity</span>
                <button class="modal-close" onclick="closeModal('activity')">&times;</button>
            </div>
            <div class="form-group">
                <label>Activity Type</label>
                <input type="text" id="maType" placeholder="e.g. Running, Cycling, Weights">
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>Duration (minutes)</label>
                    <input type="number" id="maDuration" min="0" placeholder="45">
                </div>
                <div class="form-group">
                    <label>Calories Burned</label>
                    <input type="number" id="maBurned" min="0" step="1" placeholder="350">
                </div>
            </div>
            <div class="form-group">
                <label>Intensity</label>
                <select id="maIntensity">
                    <option value="low">Low</option>
                    <option value="moderate" selected>Moderate</option>
                    <option value="high">High</option>
                </select>
            </div>
            <div class="form-group">
                <label>Notes (optional)</label>
                <input type="text" id="maNotes" placeholder="">
            </div>
            <button class="btn-save" onclick="submitActivity()">Log Activity</button>
            <div class="modal-msg" id="maMsg"></div>
        </div>
    </div>

    <div class="modal-overlay" id="modal-health">
        <div class="modal">
            <div class="modal-header">
                <span class="modal-title">Log Health Measurement</span>
                <button class="modal-close" onclick="closeModal('health')">&times;</button>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>Systolic BP (mmHg)</label>
                    <input type="number" id="mhSystolic" min="60" max="250" placeholder="120">
                </div>
                <div class="form-group">
                    <label>Diastolic BP (mmHg)</label>
                    <input type="number" id="mhDiastolic" min="40" max="150" placeholder="80">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>Blood Sugar (mg/dL)</label>
                    <input type="number" id="mhSugar" min="0" step="0.1" placeholder="95">
                </div>
                <div class="form-group">
                    <label>Blood Oxygen (SpO2 %)</label>
                    <input type="number" id="mhOxygen" min="50" max="100" step="0.1" placeholder="98">
                </div>
            </div>
            <div class="form-group">
                <label>Heart Rate (BPM)</label>
                <input type="number" id="mhHR" min="30" max="250" placeholder="72">
            </div>
            <div class="form-group">
                <label>Notes (optional)</label>
                <input type="text" id="mhNotes" placeholder="">
            </div>
            <button class="btn-save" onclick="submitHealth()">Log Measurement</button>
            <div class="modal-msg" id="mhMsg"></div>
        </div>
    </div>

    <script>
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // STATE
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        const API = '';
        let currentDate = new Date().toISOString().split('T')[0];
        let charts = {};
        let pollInterval = null;
        const POLL_INTERVAL_MS = 30000;

        // â”€â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('dateSelector').value = currentDate;
            initTabs();
            loadOverview();
            loadProfile();
            startPolling();

            // Close modals on overlay click
            document.querySelectorAll('.modal-overlay').forEach(overlay => {
                overlay.addEventListener('click', (e) => {
                    if (e.target === overlay) overlay.classList.remove('open');
                });
            });
        });

        // â”€â”€â”€ Polling â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function startPolling() {
            stopPolling();
            pollInterval = setInterval(() => {
                const overviewTab = document.getElementById('tab-overview');
                if (overviewTab && overviewTab.classList.contains('active')) {
                    loadOverview();
                }
            }, POLL_INTERVAL_MS);
        }

        function stopPolling() {
            if (pollInterval) { clearInterval(pollInterval); pollInterval = null; }
        }

        document.addEventListener('visibilitychange', () => {
            if (document.hidden) {
                stopPolling();
            } else {
                loadOverview();
                startPolling();
            }
        });

        // â”€â”€â”€ Modal Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function openModal(type) {
            document.getElementById('modal-' + type).classList.add('open');
        }

        function closeModal(type) {
            document.getElementById('modal-' + type).classList.remove('open');
        }

        function showModalMsg(id, text, isError = false) {
            const el = document.getElementById(id);
            el.textContent = text;
            el.style.color = isError ? 'var(--danger)' : 'var(--accent)';
            el.style.display = 'block';
            setTimeout(() => el.style.display = 'none', 3000);
        }

        async function submitFood() {
            const name = document.getElementById('mfName').value.trim();
            if (!name) { showModalMsg('mfMsg', 'Food name is required.', true); return; }
            const payload = {
                name,
                calories: parseFloat(document.getElementById('mfCalories').value) || 0,
                protein_g: parseFloat(document.getElementById('mfProtein').value) || 0,
                carbs_g: parseFloat(document.getElementById('mfCarbs').value) || 0,
                fat_g: parseFloat(document.getElementById('mfFat').value) || 0,
                meal_type: document.getElementById('mfMealType').value,
                quantity: document.getElementById('mfQuantity').value || null,
                notes: document.getElementById('mfNotes').value || null,
                logged_at: new Date().toISOString(),
            };
            try {
                const res = await fetch(`${API}/api/food`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload),
                });
                const data = await res.json();
                showModalMsg('mfMsg', data.message || 'Food logged!');
                ['mfName','mfCalories','mfProtein','mfCarbs','mfFat','mfQuantity','mfNotes'].forEach(id => document.getElementById(id).value = '');
                setTimeout(() => { closeModal('food'); loadOverview(); }, 800);
            } catch (err) {
                showModalMsg('mfMsg', 'Failed to log food.', true);
            }
        }

        async function submitWeight() {
            const weight = parseFloat(document.getElementById('mwWeight').value);
            if (!weight || weight < 20) { showModalMsg('mwMsg', 'Valid weight is required.', true); return; }
            const payload = {
                weight_kg: weight,
                notes: document.getElementById('mwNotes').value || null,
            };
            try {
                const res = await fetch(`${API}/api/weight`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload),
                });
                const data = await res.json();
                showModalMsg('mwMsg', data.message || 'Weight logged!');
                document.getElementById('mwWeight').value = '';
                document.getElementById('mwNotes').value = '';
                setTimeout(() => { closeModal('weight'); loadOverview(); }, 800);
            } catch (err) {
                showModalMsg('mwMsg', 'Failed to log weight.', true);
            }
        }

        async function submitActivity() {
            const actType = document.getElementById('maType').value.trim();
            if (!actType) { showModalMsg('maMsg', 'Activity type is required.', true); return; }
            const payload = {
                activity_type: actType,
                duration_minutes: parseInt(document.getElementById('maDuration').value) || 0,
                calories_burned: parseFloat(document.getElementById('maBurned').value) || 0,
                intensity: document.getElementById('maIntensity').value,
                notes: document.getElementById('maNotes').value || null,
            };
            try {
                const res = await fetch(`${API}/api/activity`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload),
                });
                const data = await res.json();
                showModalMsg('maMsg', data.message || 'Activity logged!');
                ['maType','maDuration','maBurned','maNotes'].forEach(id => document.getElementById(id).value = '');
                setTimeout(() => { closeModal('activity'); loadOverview(); }, 800);
            } catch (err) {
                showModalMsg('maMsg', 'Failed to log activity.', true);
            }
        }

        async function submitHealth() {
            const payload = {
                systolic_bp: parseInt(document.getElementById('mhSystolic').value) || null,
                diastolic_bp: parseInt(document.getElementById('mhDiastolic').value) || null,
                blood_sugar: parseFloat(document.getElementById('mhSugar').value) || null,
                blood_oxygen: parseFloat(document.getElementById('mhOxygen').value) || null,
                heart_rate: parseInt(document.getElementById('mhHR').value) || null,
                notes: document.getElementById('mhNotes').value || null,
            };
            if (!payload.systolic_bp && !payload.blood_sugar && !payload.blood_oxygen && !payload.heart_rate) {
                showModalMsg('mhMsg', 'Enter at least one measurement.', true);
                return;
            }
            try {
                const res = await fetch(`${API}/api/health`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload),
                });
                const data = await res.json();
                showModalMsg('mhMsg', data.message || 'Health measurement logged!');
                ['mhSystolic','mhDiastolic','mhSugar','mhOxygen','mhHR','mhNotes'].forEach(id => document.getElementById(id).value = '');
                setTimeout(() => { closeModal('health'); loadHealth(); }, 800);
            } catch (err) {
                showModalMsg('mhMsg', 'Failed to log measurement.', true);
            }
        }


        // â”€â”€â”€ Gamification â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        async function loadGamification() {
            try {
                const res = await fetch(`${API}/api/gamification`);
                const data = await res.json();
                if (data.error) return;

                // Streak
                document.getElementById('streak-days').textContent = data.streak_days;
                document.getElementById('streak-icon').textContent = data.is_elite ? 'ğŸ’ ' : 'ğŸ”¥';

                // Points
                document.getElementById('daily-points').textContent = data.today_points;

            } catch (err) {
                console.error('Gamification load error:', err);
            }
        }

        // â”€â”€â”€ Date Navigation â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function changeDate(delta) {
            const d = new Date(currentDate);
            d.setDate(d.getDate() + delta);
            currentDate = d.toISOString().split('T')[0];
            document.getElementById('dateSelector').value = currentDate;
            loadOverview();
        }

        function onDateChange() {
            currentDate = document.getElementById('dateSelector').value;
            loadOverview();
        }

        function goToday() {
            currentDate = new Date().toISOString().split('T')[0];
            document.getElementById('dateSelector').value = currentDate;
            loadOverview();
        }

        // â”€â”€â”€ Tabs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function initTabs() {
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
                    
                    tab.classList.add('active');
                    document.getElementById('tab-' + tab.dataset.tab).classList.add('active');

                    if (tab.dataset.tab === 'charts') loadCharts(7);
                    if (tab.dataset.tab === 'health') loadHealth();
                    if (tab.dataset.tab === 'profile') loadProfile();
                });
            });
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // OVERVIEW
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        async function loadOverview() {
            try {
                loadGamification(); // Refresh gamification status
                const res = await fetch(`${API}/api/daily-summary?date=${currentDate}`);
                const data = await res.json();
                
                if (data.error) {
                    console.warn(data.error);
                    return;
                }

                const { goals, intake, remaining, food_entries, activities, latest_weight, profile } = data;

                // Calorie ring
                const pct = goals.calorie_goal > 0 ? Math.min(intake.calories / goals.calorie_goal, 1.5) : 0;
                const circumference = 314.16;
                const offset = circumference * (1 - Math.min(pct, 1));
                const ring = document.getElementById('calorieRing');
                ring.style.strokeDashoffset = offset;
                ring.style.stroke = pct > 1 ? 'var(--danger)' : 'var(--accent)';
                
                document.getElementById('caloriesEaten').textContent = Math.round(intake.calories);
                document.getElementById('calorieGoal').textContent = Math.round(goals.calorie_goal);
                document.getElementById('caloriesRemaining').textContent = Math.round(Math.max(remaining.calories, 0));

                // Macros
                updateMacroBar('protein', intake.protein_g, goals.protein_goal_g);
                updateMacroBar('carbs', intake.carbs_g, goals.carbs_goal_g);
                updateMacroBar('fat', intake.fat_g, goals.fat_goal_g);

                // Macro status labels (calculated from daily-summary, not gamification)
                const proteinEl = document.getElementById('status-protein');
                if (intake.protein_g >= goals.protein_goal_g) {
                    proteinEl.textContent = 'good'; proteinEl.style.color = '#3ecf8e';
                } else {
                    proteinEl.textContent = 'low'; proteinEl.style.color = '#f87171';
                }

                const carbsEl = document.getElementById('status-carbs');
                if (intake.carbs_g <= goals.carbs_goal_g) {
                    carbsEl.textContent = 'good'; carbsEl.style.color = '#3ecf8e';
                } else {
                    carbsEl.textContent = 'over'; carbsEl.style.color = '#f87171';
                }

                const fatEl = document.getElementById('status-fat');
                if (intake.fat_g <= goals.fat_goal_g) {
                    fatEl.textContent = 'good'; fatEl.style.color = '#3ecf8e';
                } else {
                    fatEl.textContent = 'over'; fatEl.style.color = '#f87171';
                }

                // Quick stats
                document.getElementById('currentWeight').textContent = latest_weight ? latest_weight.weight_kg : 'â€”';
                document.getElementById('goalWeight').textContent = profile?.weight_goal_kg || 'â€”';
                document.getElementById('deficitTarget').textContent = profile?.calorie_deficit || 500;
                
                const burned = activities.reduce((sum, a) => sum + a.calories_burned, 0);
                document.getElementById('activityBurned').textContent = Math.round(burned);

                // Food log
                renderFoodLog(food_entries);
                
                // Activities
                renderActivities(activities);

            } catch (err) {
                console.error('Failed to load overview:', err);
            }
        }

        function updateMacroBar(macro, value, goal) {
            const pct = goal > 0 ? Math.min((value / goal) * 100, 100) : 0;
            document.getElementById(macro + 'Val').textContent = Math.round(value);
            document.getElementById(macro + 'Goal').textContent = Math.round(goal);
            document.getElementById(macro + 'Bar').style.width = pct + '%';
        }

        function renderFoodLog(entries) {
            const tbody = document.getElementById('foodTableBody');
            const empty = document.getElementById('foodEmpty');
            const container = document.getElementById('foodTableContainer');
            const count = document.getElementById('foodCount');
            
            count.textContent = entries.length + ' entries';

            if (entries.length === 0) {
                container.style.display = 'none';
                empty.style.display = 'block';
                return;
            }
            
            container.style.display = 'block';
            empty.style.display = 'none';

            tbody.innerHTML = entries.map(e => {
                const time = e.logged_at ? new Date(e.logged_at).toLocaleTimeString('en-GB', {hour:'2-digit', minute:'2-digit'}) : 'â€”';
                return `<tr>
                    <td class="mono">${time}</td>
                    <td><span class="meal-badge meal-${e.meal_type}">${e.meal_type}</span></td>
                    <td>${e.name}</td>
                    <td style="color:var(--text-dim);font-size:0.82rem;">${e.quantity || 'â€”'}</td>
                    <td class="mono" style="color:var(--calories);">${Math.round(e.calories)}</td>
                    <td class="mono" style="color:var(--protein);">${Math.round(e.protein_g)}</td>
                    <td class="mono" style="color:var(--carbs);">${Math.round(e.carbs_g)}</td>
                    <td class="mono" style="color:var(--fat);">${Math.round(e.fat_g)}</td>
                    <td style="text-align:right">
                        <button class="add-btn" onclick="duplicateFood(${e.id})" title="Duplicate (+)">+</button>
                        <button class="delete-btn" onclick="deleteFood(${e.id})" title="Delete">Ã—</button>
                    </td>
                </tr>`;
            }).join('');
        }

        function renderActivities(activities) {
            const list = document.getElementById('activityList');
            const empty = document.getElementById('activityEmpty');

            if (activities.length === 0) {
                list.innerHTML = '';
                empty.style.display = 'block';
                return;
            }
            
            empty.style.display = 'none';
            list.innerHTML = activities.map(a => {
                const time = a.performed_at ? new Date(a.performed_at).toLocaleTimeString('en-GB', {hour:'2-digit', minute:'2-digit'}) : '';
                return `<div style="display:flex;justify-content:space-between;align-items:center;padding:0.6rem 0;border-bottom:1px solid var(--border);">
                    <div>
                        <strong>${a.activity_type}</strong>
                        <span style="color:var(--text-dim);font-size:0.82rem;margin-left:0.75rem;">${a.duration_minutes} min Â· ${a.intensity}</span>
                    </div>
                    <div style="font-family:'Space Mono',monospace;color:var(--warning);">-${Math.round(a.calories_burned)} kcal</div>
                </div>`;
            }).join('');
        }

        async function deleteFood(id) {
            if (!confirm('Delete this food entry?')) return;
            await fetch(`${API}/api/food/${id}`, { method: 'DELETE' });
            loadOverview();
        }

        async function duplicateFood(id) {
            // 1. Get the existing entry details (we can find it in the current list or fetch it)
            // Ideally we'd have a GET /api/food/{id} but we can just use the table data if we stored it,
            // or safer: fetch the list again and find it.
            // Let's assume we can fetch it via the list logic or just reconstruct it.
            // A better way: The duplicate button logic should ideally have access to the entry data directly.
            // Since I rendered the HTML string without passing the object, I'll fetch the single item via API first?
            // Actually, my API doesn't have a GET /api/food/{id}. I should add it or just cheat.
            
            // Cheat: I will find the row in the DOM or better, store data in a global variable.
            // Let's reload the data to find it.
            
            try {
                const res = await fetch(`${API}/api/food?date=${currentDate}`);
                const data = await res.json();
                const entry = data.entries.find(e => e.id === id);
                
                if (!entry) return; // Should not happen
                
                const newEntry = {
                    name: entry.name,
                    calories: entry.calories,
                    protein_g: entry.protein_g,
                    carbs_g: entry.carbs_g,
                    fat_g: entry.fat_g,
                    meal_type: entry.meal_type,
                    quantity: entry.quantity,
                    notes: entry.notes,
                    logged_at: new Date().toISOString() // NOW
                };
                
                await fetch(`${API}/api/food`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(newEntry)
                });
                
                loadOverview(); // Refresh
                
            } catch (e) {
                console.error("Duplicate failed", e);
            }
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // CHARTS
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        async function loadCharts(days, btn) {
            // Update button states
            if (btn) {
                btn.parentElement.querySelectorAll('button').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
            }

            try {
                const [totalsRes, weightRes, activityRes] = await Promise.all([
                    fetch(`${API}/api/history/daily-totals?days=${days}`),
                    fetch(`${API}/api/weight?limit=${days}`),
                    fetch(`${API}/api/activity/range?start=${daysAgo(days)}&end=${today()}`),
                ]);

                const totalsData = await totalsRes.json();
                const weightData = await weightRes.json();
                const activityData = await activityRes.json();

                renderCalorieChart(totalsData.daily_totals);
                renderMacroChart(totalsData.daily_totals);
                renderWeightChart(weightData.entries);
                renderActivityChart(activityData.entries);

            } catch (err) {
                console.error('Chart load error:', err);
            }
        }

        function daysAgo(n) {
            const d = new Date();
            d.setDate(d.getDate() - n + 1);
            return d.toISOString().split('T')[0];
        }
        
        function today() {
            return new Date().toISOString().split('T')[0];
        }

        const chartDefaults = {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { labels: { color: '#8892a0', font: { family: 'DM Sans', size: 11 } } },
            },
            scales: {
                x: { ticks: { color: '#8892a0', font: { family: 'Space Mono', size: 10 } }, grid: { color: 'rgba(42,48,56,0.5)' }, },
                y: { ticks: { color: '#8892a0', font: { family: 'Space Mono', size: 10 } }, grid: { color: 'rgba(42,48,56,0.5)' }, },
            },
        };

        function destroyChart(key) {
            if (charts[key]) {
                charts[key].destroy();
                charts[key] = null;
            }
        }

        function renderCalorieChart(data) {
            destroyChart('calorie');
            const ctx = document.getElementById('calorieChart').getContext('2d');
            
            charts.calorie = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.map(d => d.date.slice(5)),
                    datasets: [
                        {
                            label: 'Intake',
                            data: data.map(d => d.calories),
                            backgroundColor: 'rgba(62,207,142,0.6)',
                            borderRadius: 4,
                        },
                        {
                            label: 'Goal',
                            data: data.map(d => d.calorie_goal),
                            type: 'line',
                            borderColor: '#f87171',
                            borderDash: [5, 5],
                            pointRadius: 0,
                            borderWidth: 2,
                            fill: false,
                        },
                    ],
                },
                options: { ...chartDefaults },
            });
        }

        function renderMacroChart(data) {
            destroyChart('macro');
            const ctx = document.getElementById('macroChart').getContext('2d');

            charts.macro = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.map(d => d.date.slice(5)),
                    datasets: [
                        // Actual data
                        {
                            label: 'Protein (g)',
                            data: data.map(d => d.protein_g),
                            borderColor: '#60a5fa',
                            backgroundColor: 'rgba(96,165,250,0.1)',
                            fill: true,
                            tension: 0.3,
                            pointRadius: 2
                        },
                        {
                            label: 'Carbs (g)',
                            data: data.map(d => d.carbs_g),
                            borderColor: '#fbbf24',
                            backgroundColor: 'rgba(251,191,36,0.1)',
                            fill: true,
                            tension: 0.3,
                            pointRadius: 2
                        },
                        {
                            label: 'Fat (g)',
                            data: data.map(d => d.fat_g),
                            borderColor: '#f87171',
                            backgroundColor: 'rgba(248,113,113,0.1)',
                            fill: true,
                            tension: 0.3,
                            pointRadius: 2
                        },
                        // Target/goal dashed lines
                        {
                            label: 'Protein Target',
                            data: data.map(d => d.protein_goal_g),
                            borderColor: 'rgba(96,165,250,0.4)',
                            borderDash: [6, 4],
                            borderWidth: 1.5,
                            pointRadius: 0,
                            fill: false,
                            tension: 0.3,
                        },
                        {
                            label: 'Carbs Target',
                            data: data.map(d => d.carbs_goal_g),
                            borderColor: 'rgba(251,191,36,0.4)',
                            borderDash: [6, 4],
                            borderWidth: 1.5,
                            pointRadius: 0,
                            fill: false,
                            tension: 0.3,
                        },
                        {
                            label: 'Fat Target',
                            data: data.map(d => d.fat_goal_g),
                            borderColor: 'rgba(248,113,113,0.4)',
                            borderDash: [6, 4],
                            borderWidth: 1.5,
                            pointRadius: 0,
                            fill: false,
                            tension: 0.3,
                        },
                    ],
                },
                options: { ...chartDefaults },
            });
        }

        function renderWeightChart(entries) {
            destroyChart('weight');
            const sorted = [...entries].sort((a, b) => a.measured_at.localeCompare(b.measured_at));
            const ctx = document.getElementById('weightChart').getContext('2d');
            
            charts.weight = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: sorted.map(e => e.measured_at.slice(0, 10)),
                    datasets: [{
                        label: 'Weight (kg)',
                        data: sorted.map(e => e.weight_kg),
                        borderColor: '#a78bfa',
                        backgroundColor: 'rgba(167,139,250,0.1)',
                        fill: true,
                        tension: 0.4,
                        pointRadius: 4,
                        pointBackgroundColor: '#a78bfa',
                    }],
                },
                options: { ...chartDefaults },
            });
        }

        function renderActivityChart(entries) {
            destroyChart('activity');

            // Build full date range to ensure chart shows at least 7 days
            const byDate = {};
            entries.forEach(e => {
                const day = e.performed_at.slice(0, 10);
                if (!byDate[day]) byDate[day] = { duration: 0, burned: 0, count: 0 };
                byDate[day].duration += e.duration_minutes;
                byDate[day].burned += e.calories_burned;
                byDate[day].count++;
            });

            // Fill in all dates so bars aren't oversized
            const allDates = Object.keys(byDate).sort();
            let dates = [];

            if (allDates.length > 0) {
                const earliest = new Date(allDates[0]);
                const latest = new Date(allDates[allDates.length - 1]);
                const rangeDays = Math.round((latest - earliest) / (1000 * 60 * 60 * 24)) + 1;
                const minDays = Math.max(rangeDays, 7);

                for (let i = 0; i < minDays; i++) {
                    const d = new Date(earliest);
                    d.setDate(d.getDate() + i);
                    const ds = d.toISOString().slice(0, 10);
                    dates.push(ds);
                    if (!byDate[ds]) byDate[ds] = { duration: 0, burned: 0, count: 0 };
                }
            }

            const ctx = document.getElementById('activityChart').getContext('2d');

            charts.activity = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: dates.map(d => d.slice(5)),
                    datasets: [
                        {
                            label: 'Duration (min)',
                            data: dates.map(d => byDate[d].duration),
                            backgroundColor: 'rgba(251,191,36,0.6)',
                            borderRadius: 4,
                            yAxisID: 'y',
                            maxBarThickness: 28,
                            barPercentage: 0.6,
                            categoryPercentage: 0.7,
                        },
                        {
                            label: 'Calories Burned',
                            data: dates.map(d => byDate[d].burned),
                            type: 'line',
                            borderColor: '#f87171',
                            pointRadius: 3,
                            borderWidth: 2,
                            yAxisID: 'y1',
                        },
                    ],
                },
                options: {
                    ...chartDefaults,
                    scales: {
                        ...chartDefaults.scales,
                        y1: {
                            position: 'right',
                            ticks: { color: '#f87171', font: { family: 'Space Mono', size: 10 } },
                            grid: { display: false },
                        },
                    },
                },
            });
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // HEALTH
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        async function loadHealth() {
            try {
                const res = await fetch(`${API}/api/health?limit=90`);
                const data = await res.json();
                const entries = data.entries;

                if (entries.length > 0) {
                    const latest = entries[0]; // most recent
                    
                    if (latest.systolic_bp && latest.diastolic_bp) {
                        document.getElementById('bpValue').textContent = `${latest.systolic_bp}/${latest.diastolic_bp}`;
                        const bpSt = document.getElementById('bpStatus');
                        if (latest.systolic_bp < 120 && latest.diastolic_bp < 80) {
                            bpSt.textContent = 'Normal'; bpSt.className = 'health-status status-normal';
                        } else if (latest.systolic_bp < 140) {
                            bpSt.textContent = 'Elevated'; bpSt.className = 'health-status status-warning';
                        } else {
                            bpSt.textContent = 'High'; bpSt.className = 'health-status status-danger';
                        }
                    }
                    
                    if (latest.blood_sugar) {
                        document.getElementById('sugarValue').textContent = latest.blood_sugar;
                        const sSt = document.getElementById('sugarStatus');
                        if (latest.blood_sugar < 100) {
                            sSt.textContent = 'Normal'; sSt.className = 'health-status status-normal';
                        } else if (latest.blood_sugar < 126) {
                            sSt.textContent = 'Pre-diabetic'; sSt.className = 'health-status status-warning';
                        } else {
                            sSt.textContent = 'High'; sSt.className = 'health-status status-danger';
                        }
                    }
                    
                    if (latest.blood_oxygen) {
                        document.getElementById('oxygenValue').textContent = latest.blood_oxygen + '%';
                        const oSt = document.getElementById('oxygenStatus');
                        if (latest.blood_oxygen >= 95) {
                            oSt.textContent = 'Normal'; oSt.className = 'health-status status-normal';
                        } else if (latest.blood_oxygen >= 90) {
                            oSt.textContent = 'Low'; oSt.className = 'health-status status-warning';
                        } else {
                            oSt.textContent = 'Critical'; oSt.className = 'health-status status-danger';
                        }
                    }
                    
                    if (latest.heart_rate) {
                        document.getElementById('hrValue').textContent = latest.heart_rate;
                        const hSt = document.getElementById('hrStatus');
                        if (latest.heart_rate >= 60 && latest.heart_rate <= 100) {
                            hSt.textContent = 'Normal'; hSt.className = 'health-status status-normal';
                        } else {
                            hSt.textContent = 'Check'; hSt.className = 'health-status status-warning';
                        }
                    }
                }

                // Charts
                const sorted = [...entries].sort((a, b) => a.measured_at.localeCompare(b.measured_at));
                renderBPChart(sorted);
                renderSugarOxyChart(sorted);

            } catch (err) {
                console.error('Health load error:', err);
            }
        }

        function renderBPChart(entries) {
            destroyChart('bp');
            const withBP = entries.filter(e => e.systolic_bp && e.diastolic_bp);
            const ctx = document.getElementById('bpChart').getContext('2d');
            
            charts.bp = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: withBP.map(e => e.measured_at.slice(0, 10)),
                    datasets: [
                        {
                            label: 'Systolic',
                            data: withBP.map(e => e.systolic_bp),
                            borderColor: '#f87171',
                            tension: 0.3,
                            pointRadius: 3
                        },
                        {
                            label: 'Diastolic',
                            data: withBP.map(e => e.diastolic_bp),
                            borderColor: '#60a5fa',
                            tension: 0.3,
                            pointRadius: 3
                        },
                    ],
                },
                options: { ...chartDefaults },
            });
        }

        function renderSugarOxyChart(entries) {
            destroyChart('sugarOxy');
            const ctx = document.getElementById('sugarOxyChart').getContext('2d');
            const withSugar = entries.filter(e => e.blood_sugar);
            const withOxy = entries.filter(e => e.blood_oxygen);
            
            charts.sugarOxy = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [...new Set([
                        ...withSugar.map(e => e.measured_at.slice(0, 10)),
                        ...withOxy.map(e => e.measured_at.slice(0, 10)),
                    ])].sort(),
                    datasets: [
                        {
                            label: 'Blood Sugar (mg/dL)',
                            data: withSugar.map(e => ({ x: e.measured_at.slice(0, 10), y: e.blood_sugar })),
                            borderColor: '#fbbf24',
                            tension: 0.3,
                            pointRadius: 3,
                            yAxisID: 'y',
                        },
                        {
                            label: 'SpOâ‚‚ (%)',
                            data: withOxy.map(e => ({ x: e.measured_at.slice(0, 10), y: e.blood_oxygen })),
                            borderColor: '#3ecf8e',
                            tension: 0.3,
                            pointRadius: 3,
                            yAxisID: 'y1',
                        },
                    ],
                },
                options: {
                    ...chartDefaults,
                    scales: {
                        ...chartDefaults.scales,
                        y1: {
                            position: 'right',
                            min: 85,
                            max: 100,
                            ticks: { color: '#3ecf8e', font: { family: 'Space Mono', size: 10 } },
                            grid: { display: false },
                        },
                    },
                },
            });
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // PROFILE
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        async function loadProfile() {
            try {
                const res = await fetch(`${API}/api/profile`);
                const data = await res.json();
                if (data.profile) {
                    const p = data.profile;
                    document.getElementById('pAge').value = p.age || '';
                    document.getElementById('pSex').value = p.sex || 'male';
                    document.getElementById('pHeight').value = p.height_cm || '';
                    document.getElementById('pWeight').value = p.current_weight_kg || '';
                    document.getElementById('pActivity').value = p.activity_level || 'moderate';
                    document.getElementById('pGoalWeight').value = p.weight_goal_kg || '';
                    document.getElementById('pDeficit').value = p.calorie_deficit || 500;
                    updateCalcTargets(p);
                }
            } catch (err) {
                console.error('Profile load error:', err);
            }
        }

        function updateCalcTargets(p) {
            // Simple client-side calculation for display
            let bmr = 10 * p.current_weight_kg + 6.25 * p.height_cm - 5 * p.age;
            bmr += p.sex === 'male' ? 5 : -161;
            
            const mult = { sedentary: 1.2, light: 1.375, moderate: 1.55, active: 1.725, very_active: 1.9 };
            const tdee = bmr * (mult[p.activity_level] || 1.55);
            const goal = tdee - (p.calorie_deficit || 500);
            
            document.getElementById('calcBMR').textContent = Math.round(bmr);
            document.getElementById('calcTDEE').textContent = Math.round(tdee);
            document.getElementById('calcCalGoal').textContent = Math.round(goal);
            document.getElementById('calcProt').textContent = Math.round((goal * 0.30) / 4);
            document.getElementById('calcCarbs').textContent = Math.round((goal * 0.40) / 4);
            document.getElementById('calcFat').textContent = Math.round((goal * 0.30) / 9);
        }

        async function saveProfile() {
            const payload = {
                age: parseInt(document.getElementById('pAge').value),
                sex: document.getElementById('pSex').value,
                height_cm: parseFloat(document.getElementById('pHeight').value),
                current_weight_kg: parseFloat(document.getElementById('pWeight').value),
                activity_level: document.getElementById('pActivity').value,
                weight_goal_kg: parseFloat(document.getElementById('pGoalWeight').value) || null,
                calorie_deficit: parseInt(document.getElementById('pDeficit').value) || 500,
            };

            try {
                const res = await fetch(`${API}/api/profile`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload),
                });
                const data = await res.json();
                
                const msg = document.getElementById('profileMsg');
                msg.textContent = data.message || 'Saved!';
                msg.style.display = 'block';
                setTimeout(() => msg.style.display = 'none', 3000);
                
                if (data.profile) updateCalcTargets(data.profile);
                loadOverview();
            } catch (err) {
                console.error('Save error:', err);
            }
        }
    </script>
</body>
</html>
